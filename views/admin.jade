!!! 5
html(lang='en')
  head
    meta(charset='utf-8')
    title Schedule.me
    meta(name='viewport', content='width=device-width, initial-scale=1.0')
    meta(name='description', content='')
    meta(name='author', content='nrmitchi')
    // Le styles
    link(href='./css/bootstrap.css', rel='stylesheet')
    link(href='./css/bootstrap-responsive.css', rel='stylesheet')
    link(rel='stylesheet', type='text/css', media='screen,print', href='./css/jquery-ui-1.8.21.custom.css')
    style
      @media (min-width: 979px) {
        body {
          padding-top: 60px;
        }
      }
      @media (max-width: 979px) {
        body {
          padding-top: 0px;
        }
      }
      .page {
        display:none;
        visibility:hidden;
      } .page.active {
        display:block;
        visibility:visible;
      } .add-another strong {
        -moz-border-radius: 2px;
        -webkit-border-radius: 2px;
        -o-border-radius: 2px;
        -ms-border-radius: 2px;
        -khtml-border-radius: 2px;
        border-radius: 2px;
        display: block;
        border: 1px dashed #CCC;
        line-height: 78px;
      } .add-another {
        display: block;
        -moz-border-radius: 3px;
        -webkit-border-radius: 3px;
        -o-border-radius: 3px;
        -ms-border-radius: 3px;
        -khtml-border-radius: 3px;
        border-radius: 3px;
        height: 80px;
        background: white;
        border: 1px solid #CCC;
        padding: 5px;
        text-align: center;
        cursor:pointer;
      } .add-another-wrap {
        background: #EEE;
        -moz-border-radius: 6px;
        -webkit-border-radius: 6px;
        -o-border-radius: 6px;
        -ms-border-radius: 6px;
        -khtml-border-radius: 6px;
        border-radius: 6px;
        padding: 4px;
      } .add-another:hover {
        background: #E3F0FD;
      } .name, .station {
        text-align:right; /*testing only*/
        font-size:12px;
        line-height:14px;
      } .name {
        text-align:left;
      }
      .schedule-row {
      display:block;
      padding:0;
      margin-bottom:2px;
      min-height:14px;
      } .schedule-row [class*="span"] {
      min-height:14px !important;
      } .schedule-header .snpan24 {
      width:4.166666666666666%;
      float:left;
      /*width:15px;*/
      text-align:left;
      } .schedule-header .snpan24:hover {
      background-color:#777;
      } schedule-row .btn.hidden {
      display:none;
      visibility:hidden;
      }	.schedule-row .btn {
      font-size:11px;
      line-height:12px;
      padding-top:0px;
      padding-bottom:0px;
      display:none;
      visibility:hidden;
      } .schedule-row:hover .btn {
      display:block;
      visibility:visible;
      }
    link(href='/css/bootstrap-responsive.css', rel='stylesheet')
    script(src='/js/jquery.js')
    script(src='/js/handlebars-1.0.0.beta.6.js')
    script(src='http://heapify.ca/js/jquery/jquery-ui-1.8.21.custom.min.js')
    script(src='/js/underscore.js')
    script(src='/js/backbone.js')
    script(src='/js/backbone-pushstate-router.js')
    script(src='/js/admin-application.js')
    script(src='/js/ga.js')

    // Le HTML5 shim, for IE6-8 support of HTML5 elements
    //if lt IE 9
      script(src='http://html5shim.googlecode.com/svn/trunk/html5.js')
  body
    .navbar.navbar-fixed-top
      .navbar-inner
        .container
          a.btn.btn-navbar(data-toggle='collapse', data-target='.nav-collapse')
            span.icon-bar
            span.icon-bar
            span.icon-bar
          a.brand(href='#') schedule.me
          .nav-collapse
            ul.nav

            ul.nav.pull-right
              li.dropdown
                a.dropdown-toggle(href='#', data-toggle='dropdown')
                  | My Account
                  b.caret
                ul.dropdown-menu
                  li
                    a(href='#account', delegate='pushstate') Options
                  li.divider
                  li
                    a(href='logout') Logout
          // /.nav-collapse
    .container
      .page.schedules.active
        .row
          .tabbable.tabs-left
            ul#dates.nav.nav-tabs.span3
              li.nav-header Dates
              li.nav-header#prependHere
                hl
              div
                button.btn.btn-success.btn-block.upload-modal-trigger#add_schedule(style="width:90%")
                  Upload New Schedule
              li.nav-header
                hl
              div
                li.nav-header Past Schedules
                li
                  input.datepicker#sched-date(type='text', style="width:90%")
            .tab-content
              
      .page.account
        .row-fluid
          .tabbable.tabs-left
            ul.nav.nav-tabs
              li.nav-header Options
              li.active
                a(href='#accountoptions', data-toggle='tab') Account Options
            .tab-content
              #accountoptions.tab-pane.active
                h1(style='margin-bottom: 15px;') Account Options
                .form-horizontal
                  .control-group
                    label.control-label Email: 
                    .controls
                      input#email.input-large(type='text', disabled='disabled')
                      button#edit-email-trigger.btn Edit
                      button#save-email-trigger.btn.btn-primary(style='display: none;') Save
                      p
                  .control-group
                    label.control-label Change Password:
                    .controls.input-large
                      input#oldpassword.input-large(type='password', style='margin-bottom: 9px;', placeholder='Current Password')
                      input#newpassword.input-large(type='password', style='margin-bottom: 9px;', placeholder='New Password')
                      input#newpassword1.input-large(type='password', style='margin-bottom: 9px;', placeholder='Confirm New Password')
                      button#change-password-trigger.btn.input-large(type='button', style='margin-left: 0;') Change!
                      p
                      
    #upload-modal.modal(tabindex='-1', aria-hidden='true', data-backdrop='static', style='display: none;')
      .modal-header
        h3 Upload Schedule
      .modal-body
        form(action="http://nrmitchi.schedules.s3.amazonaws.com/",method="post",enctype="multipart/form-data",id="s3-upload-form")
          input(type="hidden", name="key", id="fld_key")
          input(type="hidden", name="acl", id="fld_acl")
          input(type="hidden", name="policy", id="fld_Policy")
          input(type="hidden", name="Content-Type", id="fld_contenttype")
          input(type="hidden", name="AWSAccessKeyId", id="fld_AWSAccessKeyId")
          input(type="hidden", name="signature", id="fld_Signature")
          //- input(type="hidden", name="success_action_redirect", id="fld_redirect")
          input(type="hidden", name="redirect", id="fld_redirect")
          input(type="file", name="file", id="file", placeholder="file")
          input.btn.btn-success.btn-large(type="submit", name="submit2", id="upload_submit")

          input.datepicker#upload-schedule-date(type="text", name="date", placeholder="YYYY-MM-DD")
      .modal-footer
        button.btn(data-dismiss='modal') Cancel

    // Placed at the end of the document so the pages load faster
    script(src='./js/bootstrap.js')
    script
      $(document).ready(function() {
        //This should instead pluck the names of all employees
        var data = new Array("Andrew","Brandon","Connor","David","Julie","Michelle","Janice","Jackson","Nicole","Samanth","Evan","Nick","Johnathan","Matt");
        $('.employee-typeahead').typeahead({source: data});
        $('#sched-date').datepicker({
          showOtherMonths: true,
          dateFormat: 'yy-mm-dd',
          maxDate: "+0D"
        });
        $('#upload-schedule-date').datepicker({
          showOtherMonths: true,
          dateFormat: 'yy-mm-dd',
          minDate: "+0D"
        });
        $( ".shift-slider" ).slider({
          range: true,
          min: 6,
          max: 30,
          values: [ 8, 12 ],
          step: 0.25,
          slide: function( event, ui ) {
            var start = ui.values[0];
            var start_12 = Math.floor(start % 12);
            var end = ui.values[1];
            var end_12 = Math.floor(end % 12);
            var start_minutes = (start % 1)*60;
            start_minutes = (start_minutes < 10 ? '0' : '') + start_minutes;
            var end_minutes = (end % 1)*60;
            end_minutes = (end_minutes < 10 ? '0' : '') + end_minutes;
            $('#amount').val( (start_12 != '0' ? start_12 : '12' ) + ':' + start_minutes + ((start<12 || start>=24) ? "am" : "pm") + " - " + (end_12 != '0' ? end_12 : '12') + ':' + end_minutes + ((end<12 || end>=24) ? "am" : "pm") );
          }
        });
        $('#edit-email-trigger').click(function () {
          $('#email').removeAttr('disabled');
          $('#save-email-trigger').show();
          $(this).hide();
        });
        $('#save-email-trigger').click(function () {
          function validateEmail(email) {
            var re = /^(([^<>()[\\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
            return re.test(email);
          }

          if (validateEmail($('#email').val())) {
            console.log('email valid. changing email');
            $('#email').attr('disabled','');
            $('#edit-email-trigger').show();
            $(this).hide();
          } else {
            console.log('the entered email is not valid');
          }
        });
        $('#change-password-trigger').click(function () {
          console.log('trying to changing password...');
          function validatePasswords () {
            var newpass = $('#newpassword').val();
            var newpass1 = $('#newpassword1').val();
            if (newpass.length < 6) {
              return 3;
            }
            if (newpass != newpass1) {
              return 2;
            }
            return 1;
          }

          console.log('validating password change...');

          var validate = validatePasswords();
          if (validate == 1) {
            if ( $('#oldpassword').val() != $('#newpassword').val() ) {
              console.log('Inputs valid.');
              $.ajax({url: '/me/changePassword',
                type: 'POST',
                data: 'oldpassword='+$('#oldpassword').val()+'&newpassword='+$('#newpassword').val(),
                success: function (response) {
                  alert ('Password successfully changed!');
                  //Clear fields
                  $('#oldpassword').val('');
                  $('#newpassword').val('');
                  $('#newpassword1').val('');
                }, error: function () {
                  alert ('Password change failed.');
                }
              });
              console.log('after request...');
            } else {
              console.log('The new password cannot match the old password');
            }
          } else if (validate == 2) {
            console.log('The new password entries must match.');
          } else if (validate == 3) {
            console.log('Your new password must be at last 6 characters long');
          }
        });
        $('.ui-slider-handle').hide();
        $('.upload-modal-trigger').click(function () {
          $('#upload-modal').modal('show');
        });
      });

    script#employee-template(type='text/x-handlebars-template')
      <div class="well">
      <h1 class="name"><%= name =></h1>
      <p class="number"><$= enumber =></p>
      </div>
    // Note: I will probably use the jquery UI slider for each shift on admin page
    script#shift-template(type='text/x-handlebars-template')
      <div class="span2">
      <div class="span6 name">{{name}}</div>
      <div class="span6 station">{{pos}}</div>
      </div>
      <div class="span9">
      <div class="shift-slider"></div>
      </div>
      <div class="span1 btn edit-shift">Edit</div>
      <div class="span1 btn save-shift">Save</div>
    script#approval-template(type='text/template')

    script(id='schedule-template', type='text/x-handlebars-template')
      <h1>{{outputDate}}</h1>
      <iframe src="http://docs.google.com/gview?url=https://s3.amazonaws.com/nrmitchi.schedules/{{url}}&embedded=true" style="width:100%; min-width:200px; height:700px;" frameborder="0"></iframe>

    script
      function processResponse( res1 ) {
        window.res = JSON.parse(res1);

        $("#fld_redirect").val(res.s3Redirect);
        $("#fld_AWSAccessKeyId").val(res.s3Key);
        $("#fld_Policy").val(res.s3PolicyBase64);
        $("#fld_Signature").val(res.s3Signature);
        $("#fld_contenttype").val('application/pdf');
        $("#fld_key").val(res.key);
        $("#fld_acl").val(res.acl);

        $('#s3-upload-form').submit();
      }

      requestCredentials = function(event) {
        event.preventDefault();

        $.ajax({
          url: "/upload",
          type: 'POST',
          data: $('#upload-schedule-date').serialize(),
          success: function (res) {
            console.log('received success');
            processResponse(res);
          },
          error: function(res, status, error) {
            console.log('received an error');
          }
        });
      }

      $( "#upload_submit" ).bind( "click", requestCredentials );